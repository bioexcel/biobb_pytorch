<!DOCTYPE html>
<html>
   <head>
      <title>biobb_pytorch/mdae/loss/utils/openmm_thread.py - flake8 annotated source</title>
      <meta http-equiv="Content-Type" value="text/html; charset=UTF-8">
      <link rel="stylesheet" href="styles.css">
   </head>
   <body>
      <div id="masthead" class="sev-2"></div>
      <div id="page">
         <h1>
            <a href="biobb_pytorch.mdae.loss.utils.openmm_thread.report.html">
               <img src="back.svg" alt="&#x2B05;">
               biobb_pytorch/mdae/loss/utils/openmm_thread.py source
            </a>
         </h1>

         <div id="doc">
            <div id="l1"
               class="code sev- "><tt><i>1</i> <span class="kn">import</span><span class="w"> </span><span class="nn">os</span></tt>
            </div>
            <div id="l2"
               class="code sev- "><tt><i>2</i> <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span></tt>
            </div>
            <div id="l3"
               class="code sev- "><tt><i>3</i> <span class="kn">from</span><span class="w"> </span><span class="nn">openmm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Platform</span></tt>
            </div>
            <div id="l4"
               class="code sev- "><tt><i>4</i> <span class="kn">from</span><span class="w"> </span><span class="nn">openmm.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForceField</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">,</span> <span class="n">Simulation</span></tt>
            </div>
            <div id="l5"
               class="code sev- "><tt><i>5</i> <span class="kn">from</span><span class="w"> </span><span class="nn">openmm.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">element</span> <span class="k">as</span> <span class="n">elem</span></tt>
            </div>
            <div id="l6"
               class="code sev- "><tt><i>6</i> <span class="kn">import</span><span class="w"> </span><span class="nn">openmm</span></tt>
            </div>
            <div id="l7"
               class="code sev- "><tt><i>7</i> <span class="kn">from</span><span class="w"> </span><span class="nn">openmm.app.forcefield</span><span class="w"> </span><span class="kn">import</span> <span class="n">_createResidueSignature</span></tt>
            </div>
            <div id="l8"
               class="code sev- "><tt><i>8</i> <span class="kn">from</span><span class="w"> </span><span class="nn">openmm.app.internal</span><span class="w"> </span><span class="kn">import</span> <span class="n">compiled</span></tt>
            </div>
            <div id="l9"
               class="code sev- "><tt><i>9</i> <span class="kn">from</span><span class="w"> </span><span class="nn">torchexposedintegratorplugin</span><span class="w"> </span><span class="kn">import</span> <span class="n">TorchExposedIntegrator</span></tt>
            </div>
            <div id="l10"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>10</i>     </tt>
            </div>
            <div id="l11"
               class="code sev- "><tt><i>11</i> <span class="kn">import</span><span class="w"> </span><span class="nn">torch</span></tt>
            </div>
            <div id="l12"
               class="code sev- "><tt><i>12</i> <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span></tt>
            </div>
            <div id="l13"
               class="code sev- "><tt><i>13</i> <span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span></tt>
            </div>
            <div id="l14"
               class="code sev- "><tt><i>14</i> &nbsp;</tt>
            </div>
            <div id="l15"
               class="code sev- "><tt><i>15</i> <span class="n">soft_xml_script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span></tt>
            </div>
            <div id="l16"
               class="code sev- "><tt><i>16</i> <span class="s2">&lt;ForceField&gt;</span></tt>
            </div>
            <div id="l17"
               class="code sev- "><tt><i>17</i> <span class="s2"> &lt;Script&gt;</span></tt>
            </div>
            <div id="l18"
               class="code sev- "><tt><i>18</i> <span class="s2">import openmm as mm</span></tt>
            </div>
            <div id="l19"
               class="code sev- "><tt><i>19</i> <span class="s2">nb = mm.CustomNonbondedForce(&#39;C/((r/0.2)^4+1)&#39;)</span></tt>
            </div>
            <div id="l20"
               class="code sev- "><tt><i>20</i> <span class="s2">nb.addGlobalParameter(&#39;C&#39;, 1.0)</span></tt>
            </div>
            <div id="l21"
               class="code sev- "><tt><i>21</i> <span class="s2">sys.addForce(nb)</span></tt>
            </div>
            <div id="l22"
               class="code sev- "><tt><i>22</i> <span class="s2">for i in range(sys.getNumParticles()):</span></tt>
            </div>
            <div id="l23"
               class="code sev- "><tt><i>23</i> <span class="s2">    nb.addParticle([])</span></tt>
            </div>
            <div id="l24"
               class="code sev- "><tt><i>24</i> <span class="s2">exclusions = set()</span></tt>
            </div>
            <div id="l25"
               class="code sev- "><tt><i>25</i> <span class="s2">for bond in data.bonds:</span></tt>
            </div>
            <div id="l26"
               class="code sev- "><tt><i>26</i> <span class="s2">    exclusions.add((min(bond.atom1, bond.atom2), max(bond.atom1, bond.atom2)))</span></tt>
            </div>
            <div id="l27"
               class="code sev- "><tt><i>27</i> <span class="s2">for angle in data.angles:</span></tt>
            </div>
            <div id="l28"
               class="code sev- "><tt><i>28</i> <span class="s2">    exclusions.add((min(angle[0], angle[2]), max(angle[0], angle[2])))</span></tt>
            </div>
            <div id="l29"
               class="code sev- "><tt><i>29</i> <span class="s2">for a1, a2 in exclusions:</span></tt>
            </div>
            <div id="l30"
               class="code sev- "><tt><i>30</i> <span class="s2">    nb.addExclusion(a1, a2)</span></tt>
            </div>
            <div id="l31"
               class="code sev- "><tt><i>31</i> <span class="s2"> &lt;/Script&gt;</span></tt>
            </div>
            <div id="l32"
               class="code sev- "><tt><i>32</i> <span class="s2">&lt;/ForceField&gt;</span></tt>
            </div>
            <div id="l33"
               class="code sev- "><tt><i>33</i> <span class="s2">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l34"
               class="code sev- "><tt><i>34</i> &nbsp;</tt>
            </div>
            <div id="l35"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>
               
               </ul><tt><i>35</i> <span class="k">class</span><span class="w"> </span><span class="nc">ModifiedForceField</span><span class="p">(</span><span class="n">ForceField</span><span class="p">):</span></tt>
            </div>
            <div id="l36"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>36</i>     </tt>
            </div>
            <div id="l37"
               class="code sev- "><tt><i>37</i>     <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">alternative_residue_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></tt>
            </div>
            <div id="l38"
               class="code sev- "><tt><i>38</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l39"
               class="code sev- "><tt><i>39</i> <span class="sd">        Takes all `*args` and `**kwargs` of `openmm.app.ForceField`, plus an optional parameter described here.</span></tt>
            </div>
            <div id="l40"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>40</i> <span class="sd">        </span></tt>
            </div>
            <div id="l41"
               class="code sev- "><tt><i>41</i> <span class="sd">        :param dict  alternative_residue_names: aliases for resnames, e.g., `{&#39;HIS&#39;:&#39;HIE&#39;}`.</span></tt>
            </div>
            <div id="l42"
               class="code sev- "><tt><i>42</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l43"
               class="code sev- "><tt><i>43</i>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></tt>
            </div>
            <div id="l44"
               class="code sev- "><tt><i>44</i>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alternative_residue_names</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span></tt>
            </div>
            <div id="l45"
               class="code sev- "><tt><i>45</i>             <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_residue_names</span> <span class="o">=</span> <span class="n">alternative_residue_names</span></tt>
            </div>
            <div id="l46"
               class="code sev- "><tt><i>46</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l47"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ':'</li>
               
               </ul><tt><i>47</i>             <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_residue_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HIS&#39;</span><span class="p">:</span><span class="s1">&#39;HIE&#39;</span><span class="p">}</span></tt>
            </div>
            <div id="l48"
               class="code sev- "><tt><i>48</i> &nbsp;</tt>
            </div>
            <div id="l49"
               class="code sev- "><tt><i>49</i>     <span class="k">def</span><span class="w"> </span><span class="nf">_getResidueTemplateMatches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">templateSignatures</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></tt>
            </div>
            <div id="l50"
               class="code sev- "><tt><i>50</i> <span class="w">        </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l51"
               class="code sev- "><tt><i>51</i> <span class="sd">        Return the templates that match a residue, or None if none are found.</span></tt>
            </div>
            <div id="l52"
               class="code sev- "><tt><i>52</i> &nbsp;</tt>
            </div>
            <div id="l53"
               class="code sev- "><tt><i>53</i> <span class="sd">        :param res: Topology.Residue, the residue for which template matches are to be retrieved.</span></tt>
            </div>
            <div id="l54"
               class="code sev- "><tt><i>54</i> <span class="sd">        :param bondedToAtom: list of set of int, bondedToAtom[i] is the set of atoms bonded to atom index i</span></tt>
            </div>
            <div id="l55"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W291
                     </span>
                     Trailing whitespace</li>
               
               </ul><tt><i>55</i> <span class="sd">        :returns: list with two elements [template, matches]. </span></tt>
            </div>
            <div id="l56"
               class="code sev- "><tt><i>56</i> <span class="sd">                  _TemplateData is the matching forcefield residue template, or None if no matches are found.</span></tt>
            </div>
            <div id="l57"
               class="code sev- "><tt><i>57</i> <span class="sd">                  matches is a list specifying which atom of the template each atom of the residue corresponds to,</span></tt>
            </div>
            <div id="l58"
               class="code sev- "><tt><i>58</i> <span class="sd">                  or None if it does not match the template.</span></tt>
            </div>
            <div id="l59"
               class="code sev- "><tt><i>59</i> <span class="sd">        &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l60"
               class="code sev- "><tt><i>60</i>         <span class="n">template</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l61"
               class="code sev- "><tt><i>61</i>         <span class="n">matches</span> <span class="o">=</span> <span class="kc">None</span></tt>
            </div>
            <div id="l62"
               class="code sev- "><tt><i>62</i>         <span class="k">for</span> <span class="n">matcher</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateMatchers</span><span class="p">:</span></tt>
            </div>
            <div id="l63"
               class="code sev- "><tt><i>63</i>             <span class="n">template</span> <span class="o">=</span> <span class="n">matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="p">)</span></tt>
            </div>
            <div id="l64"
               class="code sev- "><tt><i>64</i>             <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l65"
               class="code sev- "><tt><i>65</i>                 <span class="n">match</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">matchResidueToTemplate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="p">)</span></tt>
            </div>
            <div id="l66"
               class="code sev- "><tt><i>66</i>                 <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l67"
               class="code sev- "><tt><i>67</i>                     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A custom template matcher returned a template for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">), but it does not match the residue.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></tt>
            </div>
            <div id="l68"
               class="code sev- "><tt><i>68</i>                 <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">match</span><span class="p">]</span></tt>
            </div>
            <div id="l69"
               class="code sev- "><tt><i>69</i>         <span class="k">if</span> <span class="n">templateSignatures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l70"
               class="code sev- "><tt><i>70</i>             <span class="n">templateSignatures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_templateSignatures</span></tt>
            </div>
            <div id="l71"
               class="code sev- "><tt><i>71</i>         <span class="n">signature</span> <span class="o">=</span> <span class="n">_createResidueSignature</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">()])</span></tt>
            </div>
            <div id="l72"
               class="code sev- "><tt><i>72</i>         <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">templateSignatures</span><span class="p">:</span></tt>
            </div>
            <div id="l73"
               class="code sev- "><tt><i>73</i>             <span class="n">allMatches</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l74"
               class="code sev- "><tt><i>74</i>             <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">templateSignatures</span><span class="p">[</span><span class="n">signature</span><span class="p">]:</span></tt>
            </div>
            <div id="l75"
               class="code sev- "><tt><i>75</i>                 <span class="n">match</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">matchResidueToTemplate</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">bondedToAtom</span><span class="p">,</span> <span class="n">ignoreExternalBonds</span><span class="p">,</span> <span class="n">ignoreExtraParticles</span><span class="p">)</span></tt>
            </div>
            <div id="l76"
               class="code sev- "><tt><i>76</i>                 <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l77"
               class="code sev- "><tt><i>77</i>                     <span class="n">allMatches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span></tt>
            </div>
            <div id="l78"
               class="code sev- "><tt><i>78</i>             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMatches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span></tt>
            </div>
            <div id="l79"
               class="code sev- "><tt><i>79</i>                 <span class="n">template</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></tt>
            </div>
            <div id="l80"
               class="code sev- "><tt><i>80</i>                 <span class="n">matches</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></tt>
            </div>
            <div id="l81"
               class="code sev- "><tt><i>81</i>             <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMatches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span></tt>
            </div>
            <div id="l82"
               class="code sev- "><tt><i>82</i>                 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allMatches</span><span class="p">):</span></tt>
            </div>
            <div id="l83"
               class="code sev- "><tt><i>83</i>                     <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alternative_residue_names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l84"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>84</i>                     <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span></tt>
            </div>
            <div id="l85"
               class="code sev- "><tt><i>85</i>                         <span class="n">template</span> <span class="o">=</span> <span class="n">t</span></tt>
            </div>
            <div id="l86"
               class="code sev- "><tt><i>86</i>                         <span class="n">matches</span> <span class="o">=</span> <span class="n">m</span></tt>
            </div>
            <div id="l87"
               class="code sev- "><tt><i>87</i>                         <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span></tt>
            </div>
            <div id="l88"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>88</i>                     <span class="k">elif</span> <span class="s1">&#39;N&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">==</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span></tt>
            </div>
            <div id="l89"
               class="code sev- "><tt><i>89</i>                         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">, is a being set as a N terminal residue&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l90"
               class="code sev- "><tt><i>90</i>                         <span class="n">template</span> <span class="o">=</span> <span class="n">t</span></tt>
            </div>
            <div id="l91"
               class="code sev- "><tt><i>91</i>                         <span class="n">matches</span> <span class="o">=</span> <span class="n">m</span></tt>
            </div>
            <div id="l92"
               class="code sev- "><tt><i>92</i>                         <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span></tt>
            </div>
            <div id="l93"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>93</i>                     <span class="k">elif</span> <span class="s1">&#39;C&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">==</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span></tt>
            </div>
            <div id="l94"
               class="code sev- "><tt><i>94</i>                         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s1"> is a being set as a C terminal residue&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l95"
               class="code sev- "><tt><i>95</i>                         <span class="n">template</span> <span class="o">=</span> <span class="n">t</span></tt>
            </div>
            <div id="l96"
               class="code sev- "><tt><i>96</i>                         <span class="n">matches</span> <span class="o">=</span> <span class="n">m</span></tt>
            </div>
            <div id="l97"
               class="code sev- "><tt><i>97</i>                         <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span></tt>
            </div>
            <div id="l98"
               class="code sev- "><tt><i>98</i>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;multiple for </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l99"
               class="code sev- "><tt><i>99</i>                 <span class="c1"># We found multiple matches. This is OK if and only if they assign identical types and parameters to all atoms.</span></tt>
            </div>
            <div id="l100"
               class="code sev- "><tt><i>100</i>                 <span class="n">t1</span><span class="p">,</span> <span class="n">m1</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></tt>
            </div>
            <div id="l101"
               class="code sev- "><tt><i>101</i> &nbsp;</tt>
            </div>
            <div id="l102"
               class="code sev- "><tt><i>102</i>                 <span class="k">for</span> <span class="n">t2</span><span class="p">,</span> <span class="n">m2</span> <span class="ow">in</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span></tt>
            </div>
            <div id="l103"
               class="code sev- "><tt><i>103</i>                     <span class="k">if</span> <span class="ow">not</span> <span class="n">t1</span><span class="o">.</span><span class="n">areParametersIdentical</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">):</span></tt>
            </div>
            <div id="l104"
               class="code sev- "><tt><i>104</i>                         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Multiple non-identical matching templates found for residue </span><span class="si">%d</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">): </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">allMatches</span><span class="p">)))</span></tt>
            </div>
            <div id="l105"
               class="code sev- "><tt><i>105</i>                 <span class="n">template</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></tt>
            </div>
            <div id="l106"
               class="code sev- "><tt><i>106</i>                 <span class="n">matches</span> <span class="o">=</span> <span class="n">allMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></tt>
            </div>
            <div id="l107"
               class="code sev- "><tt><i>107</i>         <span class="k">return</span> <span class="p">[</span><span class="n">template</span><span class="p">,</span> <span class="n">matches</span><span class="p">]</span></tt>
            </div>
            <div id="l108"
               class="code sev- "><tt><i>108</i> &nbsp;</tt>
            </div>
            <div id="l109"
               class="code sev- "><tt><i>109</i> &nbsp;</tt>
            </div>
            <div id="l110"
               class="code sev- "><tt><i>110</i> <span class="k">class</span><span class="w"> </span><span class="nc">OpenmmPluginScore</span><span class="p">():</span></tt>
            </div>
            <div id="l111"
               class="code sev- "><tt><i>111</i> <span class="w">    </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l112"
               class="code sev- "><tt><i>112</i> <span class="sd">    This will use the new OpenMM Plugin to calculate forces and energy. The intention is that this will be fast enough to be able to calculate forces and energy during training.</span></tt>
            </div>
            <div id="l113"
               class="code sev- "><tt><i>113</i> <span class="sd">    N.B.: The current torchintegratorplugin only supports float on GPU and double on CPU.</span></tt>
            </div>
            <div id="l114"
               class="code sev- "><tt><i>114</i> <span class="sd">    &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l115"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>115</i>     </tt>
            </div>
            <div id="l116"
               class="code sev- "><tt><i>116</i>     <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xml_file</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;amber14-all.xml&#39;</span><span class="p">],</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="n">remove_NB</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span></tt>
            </div>
            <div id="l117"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>
               
               </ul><tt><i>117</i>                  <span class="n">alternative_residue_names</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">HIS</span><span class="o">=</span><span class="s1">&#39;HIE&#39;</span><span class="p">,</span> <span class="n">HSE</span><span class="o">=</span><span class="s1">&#39;HIE&#39;</span><span class="p">),</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;CB&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">],</span></tt>
            </div>
            <div id="l118"
               class="code sev- "><tt><i>118</i>                  <span class="n">soft</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></tt>
            </div>
            <div id="l119"
               class="code sev- "><tt><i>119</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l120"
               class="code sev- "><tt><i>120</i> <span class="sd">        :param `biobox.Molecule` mol: if pldataloader is not given, then a biobox object will be taken from this parameter. If neither are given then an error  will be thrown.</span></tt>
            </div>
            <div id="l121"
               class="code sev- "><tt><i>121</i> <span class="sd">        :param str xml_file: xml parameter file</span></tt>
            </div>
            <div id="l122"
               class="code sev- "><tt><i>122</i> <span class="sd">        :param str platform: &#39;CUDA&#39; or &#39;Reference&#39;.</span></tt>
            </div>
            <div id="l123"
               class="code sev- "><tt><i>123</i> <span class="sd">        :param bool remove_NB: if True remove NonbondedForce, CustomGBForce and CMMotionRemover, else just remove CustomGBForce</span></tt>
            </div>
            <div id="l124"
               class="code sev- "><tt><i>124</i> <span class="sd">        :param dict alternative_residue_names: aliases for resnames, e.g., `{&#39;HIS&#39;:&#39;HIE&#39;}`.</span></tt>
            </div>
            <div id="l125"
               class="code sev- "><tt><i>125</i> <span class="sd">        :param atoms:</span></tt>
            </div>
            <div id="l126"
               class="code sev- "><tt><i>126</i> <span class="sd">        :param soft:</span></tt>
            </div>
            <div id="l127"
               class="code sev- "><tt><i>127</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l128"
               class="code sev- "><tt><i>128</i>         <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span></tt>
            </div>
            <div id="l129"
               class="code sev- "><tt><i>129</i>         <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">alternative_residue_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l130"
               class="code sev- "><tt><i>130</i>             <span class="c1"># self.mol.data.loc[:,&#39;resname&#39;][self.mol.data[&#39;resname&#39;]==key]=value</span></tt>
            </div>
            <div id="l131"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator (in 2 places)</li>
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>
               
               </ul><tt><i>131</i>             <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resname&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;resname&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">value</span></tt>
            </div>
            <div id="l132"
               class="code sev- "><tt><i>132</i>             <span class="c1"># self.mol.data.loc[lambda df: df[&#39;resname&#39;]==key, key]=value</span></tt>
            </div>
            <div id="l133"
               class="code sev- "><tt><i>133</i>         <span class="n">tmp_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tmp</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span><span class="si">}</span><span class="s1">.pdb&#39;</span></tt>
            </div>
            <div id="l134"
               class="code sev- "><tt><i>134</i>         <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span></tt>
            </div>
            <div id="l135"
               class="code sev- "><tt><i>135</i>         <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">split_struc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l136"
               class="code sev- "><tt><i>136</i>         <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">PDBFile</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span></tt>
            </div>
            <div id="l137"
               class="code sev- "><tt><i>137</i>         <span class="k">if</span> <span class="n">soft</span><span class="p">:</span></tt>
            </div>
            <div id="l138"
               class="code sev- "><tt><i>138</i>             <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;attempting soft forcefield&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l139"
               class="code sev- "><tt><i>139</i>             <span class="kn">from</span><span class="w"> </span><span class="nn">pdbfixer</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDBFixer</span></tt>
            </div>
            <div id="l140"
               class="code sev- "><tt><i>140</i>             <span class="n">f</span> <span class="o">=</span> <span class="n">PDBFixer</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span></tt>
            </div>
            <div id="l141"
               class="code sev- "><tt><i>141</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_createForceField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l142"
               class="code sev- "><tt><i>142</i>             <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span></tt>
            </div>
            <div id="l143"
               class="code sev- "><tt><i>143</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l144"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>
               
               </ul><tt><i>144</i>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span></tt>
            </div>
            <div id="l145"
               class="code sev- "><tt><i>145</i>                 <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">ModifiedForceField</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">alternative_residue_names</span><span class="o">=</span><span class="n">alternative_residue_names</span><span class="p">)</span></tt>
            </div>
            <div id="l146"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>146</i>             <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span></tt>
            </div>
            <div id="l147"
               class="code sev- "><tt><i>147</i>                 <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">ModifiedForceField</span><span class="p">(</span><span class="o">*</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">alternative_residue_names</span><span class="o">=</span><span class="n">alternative_residue_names</span><span class="p">)</span></tt>
            </div>
            <div id="l148"
               class="code sev- "><tt><i>148</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l149"
               class="code sev- "><tt><i>149</i>                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xml_file: </span><span class="si">{</span><span class="n">xml_file</span><span class="si">}</span><span class="s1"> needs to be a str or a list of str&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l150"
               class="code sev- "><tt><i>150</i> &nbsp;</tt>
            </div>
            <div id="l151"
               class="code sev- "><tt><i>151</i>             <span class="k">if</span> <span class="n">atoms</span> <span class="o">==</span> <span class="s1">&#39;no_hydrogen&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l152"
               class="code sev- "><tt><i>152</i>                 <span class="bp">self</span><span class="o">.</span><span class="n">ignore_hydrogen</span><span class="p">()</span></tt>
            </div>
            <div id="l153"
               class="code sev- "><tt><i>153</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l154"
               class="code sev- "><tt><i>154</i>                 <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span></tt>
            </div>
            <div id="l155"
               class="code sev- "><tt><i>155</i>             <span class="c1"># save pdb and reload in modeller</span></tt>
            </div>
            <div id="l156"
               class="code sev- "><tt><i>156</i>             <span class="n">templates</span><span class="p">,</span> <span class="n">unique_unmatched_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">generateTemplatesForUnmatchedResidues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span></tt>
            </div>
            <div id="l157"
               class="code sev- "><tt><i>157</i>             <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span></tt>
            </div>
            <div id="l158"
               class="code sev- "><tt><i>158</i>             <span class="k">if</span> <span class="n">remove_NB</span><span class="p">:</span></tt>
            </div>
            <div id="l159"
               class="code sev- "><tt><i>159</i>                 <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span></tt>
            </div>
            <div id="l160"
               class="code sev- "><tt><i>160</i>                 <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forces</span><span class="p">))):</span></tt>
            </div>
            <div id="l161"
               class="code sev- "><tt><i>161</i>                     <span class="n">force</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></tt>
            </div>
            <div id="l162"
               class="code sev- "><tt><i>162</i>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="p">(</span>  <span class="c1"># openmm.PeriodicTorsionForce,</span></tt>
            </div>
            <div id="l163"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E126
                     </span>
                     Continuation line over-indented for hanging indent</li>
               
               </ul><tt><i>163</i>                                           <span class="n">openmm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="p">,</span></tt>
            </div>
            <div id="l164"
               class="code sev- "><tt><i>164</i>                                           <span class="n">openmm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">,</span></tt>
            </div>
            <div id="l165"
               class="code sev- "><tt><i>165</i>                                           <span class="n">openmm</span><span class="o">.</span><span class="n">CMMotionRemover</span><span class="p">)):</span></tt>
            </div>
            <div id="l166"
               class="code sev- "><tt><i>166</i>                         <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">removeForce</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></tt>
            </div>
            <div id="l167"
               class="code sev- "><tt><i>167</i>             <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l168"
               class="code sev- "><tt><i>168</i>                 <span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getForces</span><span class="p">()</span></tt>
            </div>
            <div id="l169"
               class="code sev- "><tt><i>169</i>                 <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">forces</span><span class="p">))):</span></tt>
            </div>
            <div id="l170"
               class="code sev- "><tt><i>170</i>                     <span class="n">force</span> <span class="o">=</span> <span class="n">forces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></tt>
            </div>
            <div id="l171"
               class="code sev- "><tt><i>171</i>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">openmm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="p">):</span></tt>
            </div>
            <div id="l172"
               class="code sev- "><tt><i>172</i>                         <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">removeForce</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span></tt>
            </div>
            <div id="l173"
               class="code sev- "><tt><i>173</i> &nbsp;</tt>
            </div>
            <div id="l174"
               class="code sev- "><tt><i>174</i>         <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">TorchExposedIntegrator</span><span class="p">()</span></tt>
            </div>
            <div id="l175"
               class="code sev- "><tt><i>175</i>         <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span></tt>
            </div>
            <div id="l176"
               class="code sev- "><tt><i>176</i>         <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span></tt>
            </div>
            <div id="l177"
               class="code sev- "><tt><i>177</i>         <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l178"
               class="code sev- "><tt><i>178</i>             <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l179"
               class="code sev- "><tt><i>179</i>         <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span></tt>
            </div>
            <div id="l180"
               class="code sev- "><tt><i>180</i>         <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span></tt>
            </div>
            <div id="l181"
               class="code sev- "><tt><i>181</i>         <span class="bp">self</span><span class="o">.</span><span class="n">get_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span></tt>
            </div>
            <div id="l182"
               class="code sev- "><tt><i>182</i>         <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span></tt>
            </div>
            <div id="l183"
               class="code sev- "><tt><i>183</i>         <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span></tt>
            </div>
            <div id="l184"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>184</i>     </tt>
            </div>
            <div id="l185"
               class="code sev- "><tt><i>185</i>     <span class="k">def</span><span class="w"> </span><span class="nf">ignore_hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></tt>
            </div>
            <div id="l186"
               class="code sev- "><tt><i>186</i>         <span class="c1"># ignore = [&#39;ASH&#39;, &#39;LYN&#39;, &#39;GLH&#39;, &#39;HID&#39;, &#39;HIP&#39;, &#39;CYM&#39;, ]</span></tt>
            </div>
            <div id="l187"
               class="code sev- "><tt><i>187</i>         <span class="n">ignore</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l188"
               class="code sev- "><tt><i>188</i>         <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l189"
               class="code sev- "><tt><i>189</i>             <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span></tt>
            </div>
            <div id="l190"
               class="code sev- "><tt><i>190</i>                 <span class="k">continue</span></tt>
            </div>
            <div id="l191"
               class="code sev- "><tt><i>191</i>             <span class="n">patchData</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchData</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_remove_h&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l192"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>192</i>             </tt>
            </div>
            <div id="l193"
               class="code sev- "><tt><i>193</i>             <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l194"
               class="code sev- "><tt><i>194</i>                 <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span></tt>
            </div>
            <div id="l195"
               class="code sev- "><tt><i>195</i>                     <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span></tt>
            </div>
            <div id="l196"
               class="code sev- "><tt><i>196</i>                         <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l197"
               class="code sev- "><tt><i>197</i>                         <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l198"
               class="code sev- "><tt><i>198</i>                         <span class="n">patchData</span><span class="o">.</span><span class="n">deletedAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomDescription</span><span class="p">)</span></tt>
            </div>
            <div id="l199"
               class="code sev- "><tt><i>199</i>                     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l200"
               class="code sev- "><tt><i>200</i>                         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span></tt>
            </div>
            <div id="l201"
               class="code sev- "><tt><i>201</i>             <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span></tt>
            </div>
            <div id="l202"
               class="code sev- "><tt><i>202</i>                 <span class="n">atom1</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></tt>
            </div>
            <div id="l203"
               class="code sev- "><tt><i>203</i>                 <span class="n">atom2</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></tt>
            </div>
            <div id="l204"
               class="code sev- "><tt><i>204</i>                 <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span> <span class="ow">or</span> <span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="ow">is</span> <span class="n">elem</span><span class="o">.</span><span class="n">hydrogen</span><span class="p">:</span></tt>
            </div>
            <div id="l205"
               class="code sev- "><tt><i>205</i>                     <span class="n">a1</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l206"
               class="code sev- "><tt><i>206</i>                     <span class="n">a2</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l207"
               class="code sev- "><tt><i>207</i>                     <span class="n">patchData</span><span class="o">.</span><span class="n">deletedBonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))</span></tt>
            </div>
            <div id="l208"
               class="code sev- "><tt><i>208</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_remove_h&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l209"
               class="code sev- "><tt><i>209</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerPatch</span><span class="p">(</span><span class="n">patchData</span><span class="p">)</span></tt>
            </div>
            <div id="l210"
               class="code sev- "><tt><i>210</i> &nbsp;</tt>
            </div>
            <div id="l211"
               class="code sev- "><tt><i>211</i>     <span class="k">def</span><span class="w"> </span><span class="nf">atomselect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span></tt>
            </div>
            <div id="l212"
               class="code sev- "><tt><i>212</i>         <span class="n">atoms</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span></tt>
            </div>
            <div id="l213"
               class="code sev- "><tt><i>213</i>         <span class="k">if</span> <span class="s1">&#39;OT2&#39;</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l214"
               class="code sev- "><tt><i>214</i>             <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;OXT&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l215"
               class="code sev- "><tt><i>215</i>         <span class="k">if</span> <span class="s1">&#39;OT1&#39;</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l216"
               class="code sev- "><tt><i>216</i>             <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;OXT&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l217"
               class="code sev- "><tt><i>217</i> &nbsp;</tt>
            </div>
            <div id="l218"
               class="code sev- "><tt><i>218</i>         <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">_templates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span></tt>
            </div>
            <div id="l219"
               class="code sev- "><tt><i>219</i>             <span class="n">patchData</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchData</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_leave_only_&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l220"
               class="code sev- "><tt><i>220</i> &nbsp;</tt>
            </div>
            <div id="l221"
               class="code sev- "><tt><i>221</i>             <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l222"
               class="code sev- "><tt><i>222</i>                 <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l223"
               class="code sev- "><tt><i>223</i>                     <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="p">:</span></tt>
            </div>
            <div id="l224"
               class="code sev- "><tt><i>224</i>                         <span class="n">patchData</span><span class="o">.</span><span class="n">allAtomNames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l225"
               class="code sev- "><tt><i>225</i>                         <span class="n">atomDescription</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l226"
               class="code sev- "><tt><i>226</i>                         <span class="n">patchData</span><span class="o">.</span><span class="n">deletedAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomDescription</span><span class="p">)</span></tt>
            </div>
            <div id="l227"
               class="code sev- "><tt><i>227</i>                     <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l228"
               class="code sev- "><tt><i>228</i>                         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span></tt>
            </div>
            <div id="l229"
               class="code sev- "><tt><i>229</i> &nbsp;</tt>
            </div>
            <div id="l230"
               class="code sev- "><tt><i>230</i>             <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span></tt>
            </div>
            <div id="l231"
               class="code sev- "><tt><i>231</i>                 <span class="n">atom1</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></tt>
            </div>
            <div id="l232"
               class="code sev- "><tt><i>232</i>                 <span class="n">atom2</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></tt>
            </div>
            <div id="l233"
               class="code sev- "><tt><i>233</i>                 <span class="k">if</span> <span class="n">atom1</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span> <span class="ow">or</span> <span class="n">atom2</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l234"
               class="code sev- "><tt><i>234</i>                     <span class="n">a1</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l235"
               class="code sev- "><tt><i>235</i>                     <span class="n">a2</span> <span class="o">=</span> <span class="n">ForceField</span><span class="o">.</span><span class="n">_PatchAtomData</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></tt>
            </div>
            <div id="l236"
               class="code sev- "><tt><i>236</i>                     <span class="n">patchData</span><span class="o">.</span><span class="n">deletedBonds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">))</span></tt>
            </div>
            <div id="l237"
               class="code sev- "><tt><i>237</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerTemplatePatch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_leave_only_&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></tt>
            </div>
            <div id="l238"
               class="code sev- "><tt><i>238</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">registerPatch</span><span class="p">(</span><span class="n">patchData</span><span class="p">)</span></tt>
            </div>
            <div id="l239"
               class="code sev- "><tt><i>239</i> &nbsp;</tt>
            </div>
            <div id="l240"
               class="code sev- "><tt><i>240</i>     <span class="k">def</span><span class="w"> </span><span class="nf">get_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_ptr</span><span class="p">,</span> <span class="n">force_ptr</span><span class="p">,</span> <span class="n">energy_ptr</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span></tt>
            </div>
            <div id="l241"
               class="code sev- "><tt><i>241</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l242"
               class="code sev- "><tt><i>242</i> <span class="sd">        :param pos_ptr: tensor.data_ptr()</span></tt>
            </div>
            <div id="l243"
               class="code sev- "><tt><i>243</i> <span class="sd">        :param force_ptr: tensor.data_ptr()</span></tt>
            </div>
            <div id="l244"
               class="code sev- "><tt><i>244</i> <span class="sd">        :param energy_ptr: tensor.data_ptr()</span></tt>
            </div>
            <div id="l245"
               class="code sev- "><tt><i>245</i> <span class="sd">        :param int n_particles: number of particles</span></tt>
            </div>
            <div id="l246"
               class="code sev- "><tt><i>246</i> <span class="sd">        :param int batch_size: batch size</span></tt>
            </div>
            <div id="l247"
               class="code sev- "><tt><i>247</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l248"
               class="code sev- "><tt><i>248</i>         <span class="k">assert</span> <span class="n">n_particles</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span></tt>
            </div>
            <div id="l249"
               class="code sev- "><tt><i>249</i>         <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span></tt>
            </div>
            <div id="l250"
               class="code sev- "><tt><i>250</i>         <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">torchMultiStructureE</span><span class="p">(</span><span class="n">pos_ptr</span><span class="p">,</span> <span class="n">force_ptr</span><span class="p">,</span> <span class="n">energy_ptr</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span></tt>
            </div>
            <div id="l251"
               class="code sev- "><tt><i>251</i>         <span class="k">return</span> <span class="kc">True</span></tt>
            </div>
            <div id="l252"
               class="code sev- "><tt><i>252</i> &nbsp;</tt>
            </div>
            <div id="l253"
               class="code sev- "><tt><i>253</i>     <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></tt>
            </div>
            <div id="l254"
               class="code sev- "><tt><i>254</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l255"
               class="code sev- "><tt><i>255</i> <span class="sd">        :param `torch.Tensor` x: shape [b, N, 3]. dtype=float. device = gpu</span></tt>
            </div>
            <div id="l256"
               class="code sev- "><tt><i>256</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l257"
               class="code sev- "><tt><i>257</i>         <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></tt>
            </div>
            <div id="l258"
               class="code sev- "><tt><i>258</i>         <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span></tt>
            </div>
            <div id="l259"
               class="code sev- "><tt><i>259</i>         <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">force</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">energy</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></tt>
            </div>
            <div id="l260"
               class="code sev- "><tt><i>260</i>         <span class="k">return</span> <span class="n">force</span><span class="p">,</span> <span class="n">energy</span></tt>
            </div>
            <div id="l261"
               class="code sev- "><tt><i>261</i> &nbsp;</tt>
            </div>
            <div id="l262"
               class="code sev- "><tt><i>262</i> &nbsp;</tt>
            </div>
            <div id="l263"
               class="code sev- "><tt><i>263</i> <span class="k">class</span><span class="w"> </span><span class="nc">OpenmmTorchEnergyMinimizer</span><span class="p">(</span><span class="n">OpenmmPluginScore</span><span class="p">):</span></tt>
            </div>
            <div id="l264"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>264</i>     </tt>
            </div>
            <div id="l265"
               class="code sev- "><tt><i>265</i>     <span class="k">def</span><span class="w"> </span><span class="nf">minimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">maxIterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span></tt>
            </div>
            <div id="l266"
               class="code sev- "><tt><i>266</i>         <span class="n">minimized_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></tt>
            </div>
            <div id="l267"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>
               
               </ul><tt><i>267</i>         <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span></tt>
            </div>
            <div id="l268"
               class="code sev- "><tt><i>268</i>             <span class="n">h</span> <span class="o">=</span> <span class="mf">0.01</span></tt>
            </div>
            <div id="l269"
               class="code sev- "><tt><i>269</i>             <span class="n">force</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></tt>
            </div>
            <div id="l270"
               class="code sev- "><tt><i>270</i>             <span class="n">abs_max</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span></tt>
            </div>
            <div id="l271"
               class="code sev- "><tt><i>271</i>             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxIterations</span><span class="p">):</span></tt>
            </div>
            <div id="l272"
               class="code sev- "><tt><i>272</i>                 <span class="n">new_s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">force</span><span class="o">*</span><span class="n">abs_max</span><span class="o">*</span><span class="n">h</span></tt>
            </div>
            <div id="l273"
               class="code sev- "><tt><i>273</i>                 <span class="n">new_force</span><span class="p">,</span> <span class="n">new_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">new_s</span><span class="p">)</span></tt>
            </div>
            <div id="l274"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>274</i>                 <span class="k">if</span> <span class="n">new_energy</span><span class="o">&lt;</span><span class="n">energy</span><span class="p">:</span></tt>
            </div>
            <div id="l275"
               class="code sev- "><tt><i>275</i>                     <span class="n">s</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="n">new_s</span><span class="p">,</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_force</span></tt>
            </div>
            <div id="l276"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>276</i>                     <span class="k">if</span> <span class="n">energy</span><span class="o">&lt;</span><span class="n">threshold</span><span class="p">:</span></tt>
            </div>
            <div id="l277"
               class="code sev- "><tt><i>277</i>                         <span class="k">break</span></tt>
            </div>
            <div id="l278"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>278</i>                     <span class="n">h</span><span class="o">*=</span><span class="mf">1.2</span></tt>
            </div>
            <div id="l279"
               class="code sev- "><tt><i>279</i> &nbsp;</tt>
            </div>
            <div id="l280"
               class="code sev- "><tt><i>280</i>                 <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l281"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>281</i>                     <span class="n">h</span><span class="o">*=</span><span class="mf">0.2</span></tt>
            </div>
            <div id="l282"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E225
                     </span>
                     Missing whitespace around operator</li>
               
               </ul><tt><i>282</i>             <span class="n">minimized_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">s</span></tt>
            </div>
            <div id="l283"
               class="code sev- "><tt><i>283</i>         <span class="k">return</span> <span class="n">minimized_x</span></tt>
            </div>
            <div id="l284"
               class="code sev- "><tt><i>284</i> &nbsp;</tt>
            </div>
            <div id="l285"
               class="code sev- "><tt><i>285</i> &nbsp;</tt>
            </div>
            <div id="l286"
               class="code sev- "><tt><i>286</i> <span class="k">class</span><span class="w"> </span><span class="nc">OpenMMPluginScoreSoftForceField</span><span class="p">(</span><span class="n">OpenmmPluginScore</span><span class="p">):</span></tt>
            </div>
            <div id="l287"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>287</i>     </tt>
            </div>
            <div id="l288"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 4 places)</li>
               
               </ul><tt><i>288</i>     <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CUDA&#39;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;CB&#39;</span><span class="p">,</span><span class="s1">&#39;O&#39;</span><span class="p">]):</span></tt>
            </div>
            <div id="l289"
               class="code sev- "><tt><i>289</i>         <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span></tt>
            </div>
            <div id="l290"
               class="code sev- "><tt><i>290</i>         <span class="n">tmp_file</span> <span class="o">=</span> <span class="s1">&#39;tmp.pdb&#39;</span></tt>
            </div>
            <div id="l291"
               class="code sev- "><tt><i>291</i>         <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span></tt>
            </div>
            <div id="l292"
               class="code sev- "><tt><i>292</i>         <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">,</span> <span class="n">split_struc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></tt>
            </div>
            <div id="l293"
               class="code sev- "><tt><i>293</i>         <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span> <span class="o">=</span> <span class="n">PDBFile</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span></tt>
            </div>
            <div id="l294"
               class="code sev- "><tt><i>294</i>         <span class="kn">from</span><span class="w"> </span><span class="nn">pdbfixer</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDBFixer</span></tt>
            </div>
            <div id="l295"
               class="code sev- "><tt><i>295</i>         <span class="n">f</span> <span class="o">=</span> <span class="n">PDBFixer</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span></tt>
            </div>
            <div id="l296"
               class="code sev- "><tt><i>296</i>         <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">_createForceField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span></tt>
            </div>
            <div id="l297"
               class="code sev- "><tt><i>297</i>         <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefield</span><span class="o">.</span><span class="n">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">)</span></tt>
            </div>
            <div id="l298"
               class="code sev- "><tt><i>298</i>         <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">TorchExposedIntegrator</span><span class="p">()</span></tt>
            </div>
            <div id="l299"
               class="code sev- "><tt><i>299</i>         <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span></tt>
            </div>
            <div id="l300"
               class="code sev- "><tt><i>300</i>         <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span></tt>
            </div>
            <div id="l301"
               class="code sev- "><tt><i>301</i>         <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;CUDA&#39;</span><span class="p">:</span></tt>
            </div>
            <div id="l302"
               class="code sev- "><tt><i>302</i>             <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">setPropertyValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">)</span></tt>
            </div>
            <div id="l303"
               class="code sev- "><tt><i>303</i>         <span class="bp">self</span><span class="o">.</span><span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getSystem</span><span class="p">()</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span></tt>
            </div>
            <div id="l304"
               class="code sev- "><tt><i>304</i>         <span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span></tt>
            </div>
            <div id="l305"
               class="code sev- "><tt><i>305</i>         <span class="bp">self</span><span class="o">.</span><span class="n">get_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energy</span></tt>
            </div>
            <div id="l306"
               class="code sev- "><tt><i>306</i>         <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span></tt>
            </div>
            <div id="l307"
               class="code sev- "><tt><i>307</i> &nbsp;</tt>
            </div>
            <div id="l308"
               class="code sev- "><tt><i>308</i> &nbsp;</tt>
            </div>
            <div id="l309"
               class="code sev- "><tt><i>309</i> <span class="k">class</span><span class="w"> </span><span class="nc">openmm_energy_function</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span></tt>
            </div>
            <div id="l310"
               class="code sev- "><tt><i>310</i> &nbsp;</tt>
            </div>
            <div id="l311"
               class="code sev- "><tt><i>311</i>     <span class="nd">@staticmethod</span></tt>
            </div>
            <div id="l312"
               class="code sev- "><tt><i>312</i>     <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></tt>
            </div>
            <div id="l313"
               class="code sev- "><tt><i>313</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l314"
               class="code sev- "><tt><i>314</i> <span class="sd">        :param plugin: OpenmmPluginScore instance</span></tt>
            </div>
            <div id="l315"
               class="code sev- "><tt><i>315</i> <span class="sd">        :param `torch.Tensor` x: dtype = float, shape = [B, N, 3], device = any</span></tt>
            </div>
            <div id="l316"
               class="code sev- "><tt><i>316</i> <span class="sd">        :returns: energy tensor, dtype = float, shape = [B], device  = any</span></tt>
            </div>
            <div id="l317"
               class="code sev- "><tt><i>317</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l318"
               class="code sev- "><tt><i>318</i>         <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span></tt>
            </div>
            <div id="l319"
               class="code sev- "><tt><i>319</i>             <span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></tt>
            </div>
            <div id="l320"
               class="code sev- "><tt><i>320</i>             <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></tt>
            </div>
            <div id="l321"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ','</li>
               
               </ul><tt><i>321</i>             <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span></tt>
            </div>
            <div id="l322"
               class="code sev- "><tt><i>322</i>                 <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span></tt>
            </div>
            <div id="l323"
               class="code sev- "><tt><i>323</i>                 <span class="n">state</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getForces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l324"
               class="code sev- "><tt><i>324</i>                 <span class="n">force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l325"
               class="code sev- "><tt><i>325</i>                 <span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span></tt>
            </div>
            <div id="l326"
               class="code sev- "><tt><i>326</i>             <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">force</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></tt>
            </div>
            <div id="l327"
               class="code sev- "><tt><i>327</i>             <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></tt>
            </div>
            <div id="l328"
               class="code sev- "><tt><i>328</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l329"
               class="code sev- "><tt><i>329</i>             <span class="c1"># torch.cuda.synchronize(x.device)</span></tt>
            </div>
            <div id="l330"
               class="code sev- "><tt><i>330</i>             <span class="n">force</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></tt>
            </div>
            <div id="l331"
               class="code sev- "><tt><i>331</i>             <span class="c1"># torch.cuda.synchronize(x.device)</span></tt>
            </div>
            <div id="l332"
               class="code sev- "><tt><i>332</i>         <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">force</span><span class="p">)</span></tt>
            </div>
            <div id="l333"
               class="code sev- "><tt><i>333</i>         <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span></tt>
            </div>
            <div id="l334"
               class="code sev- "><tt><i>334</i>         <span class="k">return</span> <span class="n">energy</span></tt>
            </div>
            <div id="l335"
               class="code sev- "><tt><i>335</i> &nbsp;</tt>
            </div>
            <div id="l336"
               class="code sev- "><tt><i>336</i>     <span class="nd">@staticmethod</span></tt>
            </div>
            <div id="l337"
               class="code sev- "><tt><i>337</i>     <span class="k">def</span><span class="w"> </span><span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span></tt>
            </div>
            <div id="l338"
               class="code sev- "><tt><i>338</i>         <span class="n">force</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># force shape [B, N, 3]</span></tt>
            </div>
            <div id="l339"
               class="code sev- "><tt><i>339</i>         <span class="c1"># embed(header=&#39;23 openmm_loss_function&#39;)</span></tt>
            </div>
            <div id="l340"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>
               
               </ul><tt><i>340</i>         <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">force</span><span class="o">*</span><span class="n">grad_output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span></tt>
            </div>
            <div id="l341"
               class="code sev- "><tt><i>341</i> &nbsp;</tt>
            </div>
            <div id="l342"
               class="code sev- "><tt><i>342</i> &nbsp;</tt>
            </div>
            <div id="l343"
               class="code sev- "><tt><i>343</i> <span class="k">class</span><span class="w"> </span><span class="nc">openmm_clamped_energy_function</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span></tt>
            </div>
            <div id="l344"
               class="code sev- "><tt><i>344</i> &nbsp;</tt>
            </div>
            <div id="l345"
               class="code sev- "><tt><i>345</i>     <span class="nd">@staticmethod</span></tt>
            </div>
            <div id="l346"
               class="code sev- "><tt><i>346</i>     <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">clamp</span><span class="p">):</span></tt>
            </div>
            <div id="l347"
               class="code sev- "><tt><i>347</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l348"
               class="code sev- "><tt><i>348</i> <span class="sd">        :param plugin: OpenmmPluginScore instance</span></tt>
            </div>
            <div id="l349"
               class="code sev- "><tt><i>349</i> <span class="sd">        :param `torch.Tensor` x: dtype = float, shape = [B, N, 3], device = cuda</span></tt>
            </div>
            <div id="l350"
               class="code sev- "><tt><i>350</i> <span class="sd">        :returns: energy tensor, dtype = double, shape = [B], device CPU</span></tt>
            </div>
            <div id="l351"
               class="code sev- "><tt><i>351</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l352"
               class="code sev- "><tt><i>352</i>         <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span></tt>
            </div>
            <div id="l353"
               class="code sev- "><tt><i>353</i>             <span class="n">force</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></tt>
            </div>
            <div id="l354"
               class="code sev- "><tt><i>354</i>             <span class="n">energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></tt>
            </div>
            <div id="l355"
               class="code sev- "><tt><i>355</i>             <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span></tt>
            </div>
            <div id="l356"
               class="code sev- "><tt><i>356</i>                 <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span></tt>
            </div>
            <div id="l357"
               class="code sev- "><tt><i>357</i>                 <span class="n">state</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getForces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l358"
               class="code sev- "><tt><i>358</i>                 <span class="n">force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getForces</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></tt>
            </div>
            <div id="l359"
               class="code sev- "><tt><i>359</i>                 <span class="n">energy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span><span class="o">.</span><span class="n">_value</span></tt>
            </div>
            <div id="l360"
               class="code sev- "><tt><i>360</i>             <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">force</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></tt>
            </div>
            <div id="l361"
               class="code sev- "><tt><i>361</i>             <span class="n">energy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span></tt>
            </div>
            <div id="l362"
               class="code sev- "><tt><i>362</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l363"
               class="code sev- "><tt><i>363</i>             <span class="n">force</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></tt>
            </div>
            <div id="l364"
               class="code sev- "><tt><i>364</i> &nbsp;</tt>
            </div>
            <div id="l365"
               class="code sev- "><tt><i>365</i>         <span class="n">force</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="o">**</span><span class="n">clamp</span><span class="p">)</span></tt>
            </div>
            <div id="l366"
               class="code sev- "><tt><i>366</i>         <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="n">force</span><span class="p">)</span></tt>
            </div>
            <div id="l367"
               class="code sev- "><tt><i>367</i>         <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span></tt>
            </div>
            <div id="l368"
               class="code sev- "><tt><i>368</i>         <span class="k">return</span> <span class="n">energy</span></tt>
            </div>
            <div id="l369"
               class="code sev- "><tt><i>369</i> &nbsp;</tt>
            </div>
            <div id="l370"
               class="code sev- "><tt><i>370</i>     <span class="nd">@staticmethod</span></tt>
            </div>
            <div id="l371"
               class="code sev- "><tt><i>371</i>     <span class="k">def</span><span class="w"> </span><span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">grad_output</span><span class="p">):</span></tt>
            </div>
            <div id="l372"
               class="code sev- "><tt><i>372</i>         <span class="n">force</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></tt>
            </div>
            <div id="l373"
               class="code sev- "><tt><i>373</i>         <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">force</span><span class="o">*</span><span class="n">grad_output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span></tt>
            </div>
            <div id="l374"
               class="code sev- "><tt><i>374</i> &nbsp;</tt>
            </div>
            <div id="l375"
               class="code sev- "><tt><i>375</i> &nbsp;</tt>
            </div>
            <div id="l376"
               class="code sev- "><tt><i>376</i> <span class="k">class</span><span class="w"> </span><span class="nc">openmm_energy</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></tt>
            </div>
            <div id="l377"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>377</i>     </tt>
            </div>
            <div id="l378"
               class="code sev- "><tt><i>378</i>     <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">clamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></tt>
            </div>
            <div id="l379"
               class="code sev- "><tt><i>379</i>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></tt>
            </div>
            <div id="l380"
               class="code sev- "><tt><i>380</i>         <span class="bp">self</span><span class="o">.</span><span class="n">openmmplugin</span> <span class="o">=</span> <span class="n">OpenmmPluginScore</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></tt>
            </div>
            <div id="l381"
               class="code sev- "><tt><i>381</i>         <span class="bp">self</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="o">/</span><span class="mi">10</span></tt>
            </div>
            <div id="l382"
               class="code sev- "><tt><i>382</i>         <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span> <span class="o">=</span> <span class="n">clamp</span></tt>
            </div>
            <div id="l383"
               class="code sev- "><tt><i>383</i>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span></tt>
            </div>
            <div id="l384"
               class="code sev- "><tt><i>384</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clamp_forward</span></tt>
            </div>
            <div id="l385"
               class="code sev- "><tt><i>385</i>         <span class="k">else</span><span class="p">:</span></tt>
            </div>
            <div id="l386"
               class="code sev- "><tt><i>386</i>             <span class="bp">self</span><span class="o">.</span><span class="n">forward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forward</span></tt>
            </div>
            <div id="l387"
               class="code sev- "><tt><i>387</i> &nbsp;</tt>
            </div>
            <div id="l388"
               class="code sev- "><tt><i>388</i>     <span class="k">def</span><span class="w"> </span><span class="nf">_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></tt>
            </div>
            <div id="l389"
               class="code sev- "><tt><i>389</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l390"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W291
                     </span>
                     Trailing whitespace</li>
               
               </ul><tt><i>390</i> <span class="sd">        :param `torch.Tensor` x: dtype=torch.float, device=CUDA, shape B, 3, N </span></tt>
            </div>
            <div id="l391"
               class="code sev- "><tt><i>391</i> <span class="sd">        :returns: torch energy tensor dtype should be float and on same device as x</span></tt>
            </div>
            <div id="l392"
               class="code sev- "><tt><i>392</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l393"
               class="code sev- "><tt><i>393</i>         <span class="n">_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span></tt>
            </div>
            <div id="l394"
               class="code sev- "><tt><i>394</i>         <span class="n">energy</span> <span class="o">=</span> <span class="n">openmm_energy_function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openmmplugin</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span></tt>
            </div>
            <div id="l395"
               class="code sev- "><tt><i>395</i>         <span class="k">return</span> <span class="n">energy</span></tt>
            </div>
            <div id="l396"
               class="code sev- "><tt><i>396</i> &nbsp;</tt>
            </div>
            <div id="l397"
               class="code sev- "><tt><i>397</i>     <span class="k">def</span><span class="w"> </span><span class="nf">_clamp_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span></tt>
            </div>
            <div id="l398"
               class="code sev- "><tt><i>398</i> <span class="w">        </span><span class="sd">&#39;&#39;&#39;</span></tt>
            </div>
            <div id="l399"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W291
                     </span>
                     Trailing whitespace</li>
               
               </ul><tt><i>399</i> <span class="sd">        :param `torch.Tensor` x: dtype=torch.float, device=CUDA, shape B, 3, N </span></tt>
            </div>
            <div id="l400"
               class="code sev- "><tt><i>400</i> <span class="sd">        :returns: torch energy tensor dtype should be float and on same device as x</span></tt>
            </div>
            <div id="l401"
               class="code sev- "><tt><i>401</i> <span class="sd">        &#39;&#39;&#39;</span></tt>
            </div>
            <div id="l402"
               class="code sev- "><tt><i>402</i>         <span class="n">_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span></tt>
            </div>
            <div id="l403"
               class="code sev- "><tt><i>403</i>         <span class="n">energy</span> <span class="o">=</span> <span class="n">openmm_clamped_energy_function</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openmmplugin</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clamp</span><span class="p">)</span></tt>
            </div>
            <div id="l404"
               class="code sev- "><tt><i>404</i>         <span class="k">return</span> <span class="n">energy</span></tt>
            </div>
            <div id="l405"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>405</i>     </tt>
            </div>
            <div id="l406"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>
               
               </ul><tt><i>406</i> <span class="k">class</span><span class="w"> </span><span class="nc">openmm_energy_setup</span><span class="p">():</span></tt>
            </div>
            <div id="l407"
               class="code sev- "><tt><i>407</i> &nbsp;</tt>
            </div>
            <div id="l408"
               class="code sev- "><tt><i>408</i>     <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">):</span></tt>
            </div>
            <div id="l409"
               class="code sev- "><tt><i>409</i> &nbsp;</tt>
            </div>
            <div id="l410"
               class="code sev- "><tt><i>410</i>         <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">topology</span></tt>
            </div>
            <div id="l411"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>411</i>         </tt>
            </div>
            <div id="l412"
               class="code sev- "><tt><i>412</i>     <span class="k">def</span><span class="w"> </span><span class="nf">get_atominfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></tt>
            </div>
            <div id="l413"
               class="code sev- "><tt><i>413</i> <span class="w">        </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l414"
               class="code sev- "><tt><i>414</i> <span class="sd">        Get the atom information from the topology.</span></tt>
            </div>
            <div id="l415"
               class="code sev- "><tt><i>415</i> <span class="sd">        &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l416"
               class="code sev- "><tt><i>416</i>         <span class="n">atom_info</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l417"
               class="code sev- "><tt><i>417</i>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l418"
               class="code sev- "><tt><i>418</i>             <span class="n">atom_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span></tt>
            </div>
            <div id="l419"
               class="code sev- "><tt><i>419</i>         <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_info</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span></tt>
            </div>
            <div id="l420"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W293
                     </span>
                     Blank line contains whitespace</li>
               
               </ul><tt><i>420</i>     </tt>
            </div>
            <div id="l421"
               class="code sev- "><tt><i>421</i>     <span class="k">def</span><span class="w"> </span><span class="nf">mol_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></tt>
            </div>
            <div id="l422"
               class="code sev- "><tt><i>422</i> <span class="w">        </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l423"
               class="code sev- "><tt><i>423</i> <span class="sd">        Get the atom information from the topology and convert it to a pandas DataFrame.</span></tt>
            </div>
            <div id="l424"
               class="code sev- "><tt><i>424</i> <span class="sd">        &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l425"
               class="code sev- "><tt><i>425</i>         <span class="k">return</span> <span class="n">MolDataFrame</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span></tt>
            </div>
            <div id="l426"
               class="code sev- "><tt><i>426</i> &nbsp;</tt>
            </div>
            <div id="l427"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E302
                     </span>
                     Expected 2 blank lines, found 1</li>
               
               </ul><tt><i>427</i> <span class="k">class</span><span class="w"> </span><span class="nc">MolDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span></tt>
            </div>
            <div id="l428"
               class="code sev- "><tt><i>428</i> <span class="w">    </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l429"
               class="code sev- "><tt><i>429</i> <span class="sd">    Subclass of pandas.DataFrame specialized for molecular data.</span></tt>
            </div>
            <div id="l430"
               class="code sev- "><tt><i>430</i> <span class="sd">    Stores atomic information plus coordinates, and can write itself to PDB.</span></tt>
            </div>
            <div id="l431"
               class="code sev- "><tt><i>431</i> <span class="sd">    &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l432"
               class="code sev- "><tt><i>432</i>     <span class="nd">@property</span></tt>
            </div>
            <div id="l433"
               class="code sev- "><tt><i>433</i>     <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></tt>
            </div>
            <div id="l434"
               class="code sev- "><tt><i>434</i>         <span class="k">return</span> <span class="bp">self</span></tt>
            </div>
            <div id="l435"
               class="code sev- "><tt><i>435</i> &nbsp;</tt>
            </div>
            <div id="l436"
               class="code sev- "><tt><i>436</i>     <span class="nd">@property</span></tt>
            </div>
            <div id="l437"
               class="code sev- "><tt><i>437</i>     <span class="k">def</span><span class="w"> </span><span class="nf">_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></tt>
            </div>
            <div id="l438"
               class="code sev- "><tt><i>438</i>         <span class="k">return</span> <span class="n">MolDataFrame</span></tt>
            </div>
            <div id="l439"
               class="code sev- "><tt><i>439</i> &nbsp;</tt>
            </div>
            <div id="l440"
               class="code sev- "><tt><i>440</i>     <span class="nd">@classmethod</span></tt>
            </div>
            <div id="l441"
               class="code sev- "><tt><i>441</i>     <span class="k">def</span><span class="w"> </span><span class="nf">from_trajectory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></tt>
            </div>
            <div id="l442"
               class="code sev- "><tt><i>442</i> <span class="w">        </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l443"
               class="code sev- "><tt><i>443</i> <span class="sd">        Build MolDataFrame from an mdtraj.Trajectory `traj`.</span></tt>
            </div>
            <div id="l444"
               class="code sev- "><tt><i>444</i> <span class="sd">        - `frame`: index of the frame whose coords to use (default 0).</span></tt>
            </div>
            <div id="l445"
               class="code sev- "><tt><i>445</i> <span class="sd">        Adds x, y, z columns.</span></tt>
            </div>
            <div id="l446"
               class="code sev- "><tt><i>446</i> <span class="sd">        &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l447"
               class="code sev- "><tt><i>447</i>         <span class="c1"># Atomic radii map ()</span></tt>
            </div>
            <div id="l448"
               class="code sev- "><tt><i>448</i>         <span class="n">radius_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mf">1.55</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mf">1.70</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="mf">1.52</span><span class="p">,</span></tt>
            </div>
            <div id="l449"
               class="code sev- "><tt><i>449</i>                        <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">1.20</span><span class="p">}</span></tt>
            </div>
            <div id="l450"
               class="code sev- "><tt><i>450</i> &nbsp;</tt>
            </div>
            <div id="l451"
               class="code sev- "><tt><i>451</i>         <span class="k">def</span><span class="w"> </span><span class="nf">idx_to_letters</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span></tt>
            </div>
            <div id="l452"
               class="code sev- "><tt><i>452</i>             <span class="n">letters</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></tt>
            </div>
            <div id="l453"
               class="code sev- "><tt><i>453</i>             <span class="k">while</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span></tt>
            </div>
            <div id="l454"
               class="code sev- "><tt><i>454</i>                 <span class="n">letters</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">26</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">letters</span></tt>
            </div>
            <div id="l455"
               class="code sev- "><tt><i>455</i>                 <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="mi">26</span> <span class="o">-</span> <span class="mi">1</span></tt>
            </div>
            <div id="l456"
               class="code sev- "><tt><i>456</i>             <span class="k">return</span> <span class="n">letters</span></tt>
            </div>
            <div id="l457"
               class="code sev- "><tt><i>457</i> &nbsp;</tt>
            </div>
            <div id="l458"
               class="code sev- "><tt><i>458</i>         <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span></tt>
            </div>
            <div id="l459"
               class="code sev- "><tt><i>459</i>         <span class="n">coords</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>  <span class="c1"># shape (n_atoms,3)</span></tt>
            </div>
            <div id="l460"
               class="code sev- "><tt><i>460</i>         <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span></tt>
            </div>
            <div id="l461"
               class="code sev- "><tt><i>461</i>             <span class="n">i</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span></tt>
            </div>
            <div id="l462"
               class="code sev- "><tt><i>462</i>             <span class="c1"># occupancy and B-factor</span></tt>
            </div>
            <div id="l463"
               class="code sev- "><tt><i>463</i>             <span class="n">occ</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="s1">&#39;occupancies&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]])[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></tt>
            </div>
            <div id="l464"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ','</li>
               
               </ul><tt><i>464</i>             <span class="n">beta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="s1">&#39;bfactors&#39;</span><span class="p">,</span>    <span class="p">[[</span><span class="kc">None</span><span class="p">]])[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></tt>
            </div>
            <div id="l465"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E221
                     </span>
                     Multiple spaces before operator</li>
               
                  <li>
                     <span class="count sev-2">
                        E272
                     </span>
                     Multiple spaces before keyword</li>
               
               </ul><tt><i>465</i>             <span class="n">occ</span>  <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">occ</span>  <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">occ</span></tt>
            </div>
            <div id="l466"
               class="code sev- "><tt><i>466</i>             <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta</span></tt>
            </div>
            <div id="l467"
               class="code sev- "><tt><i>467</i> &nbsp;</tt>
            </div>
            <div id="l468"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E221
                     </span>
                     Multiple spaces before operator</li>
               
               </ul><tt><i>468</i>             <span class="n">name</span>    <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span></tt>
            </div>
            <div id="l469"
               class="code sev- "><tt><i>469</i>             <span class="n">element</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="k">else</span> <span class="kc">None</span></tt>
            </div>
            <div id="l470"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E221
                     </span>
                     Multiple spaces before operator</li>
               
               </ul><tt><i>470</i>             <span class="n">radius</span>  <span class="o">=</span> <span class="n">radius_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span></tt>
            </div>
            <div id="l471"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E128
                     </span>
                     Continuation line under-indented for visual indent</li>
               
               </ul><tt><i>471</i>                         <span class="n">radius_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></tt>
            </div>
            <div id="l472"
               class="code sev- "><tt><i>472</i>             <span class="n">charge</span> <span class="o">=</span> <span class="mf">0.0</span></tt>
            </div>
            <div id="l473"
               class="code sev- "><tt><i>473</i> &nbsp;</tt>
            </div>
            <div id="l474"
               class="code sev- "><tt><i>474</i>             <span class="c1"># chain as letters</span></tt>
            </div>
            <div id="l475"
               class="code sev- "><tt><i>475</i>             <span class="n">cid</span> <span class="o">=</span> <span class="n">idx_to_letters</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></tt>
            </div>
            <div id="l476"
               class="code sev- "><tt><i>476</i> &nbsp;</tt>
            </div>
            <div id="l477"
               class="code sev- "><tt><i>477</i>             <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></tt>
            </div>
            <div id="l478"
               class="code sev- "><tt><i>478</i>             <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span></tt>
            </div>
            <div id="l479"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>479</i>                 <span class="s1">&#39;atom&#39;</span><span class="p">:</span>      <span class="s1">&#39;ATOM&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l480"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>480</i>                 <span class="s1">&#39;index&#39;</span><span class="p">:</span>     <span class="n">i</span><span class="p">,</span></tt>
            </div>
            <div id="l481"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>481</i>                 <span class="s1">&#39;name&#39;</span><span class="p">:</span>      <span class="n">name</span><span class="p">,</span></tt>
            </div>
            <div id="l482"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>482</i>                 <span class="s1">&#39;resname&#39;</span><span class="p">:</span>   <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span></tt>
            </div>
            <div id="l483"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>483</i>                 <span class="s1">&#39;chain&#39;</span><span class="p">:</span>     <span class="n">cid</span><span class="p">,</span></tt>
            </div>
            <div id="l484"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>484</i>                 <span class="s1">&#39;resid&#39;</span><span class="p">:</span>     <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span></tt>
            </div>
            <div id="l485"
               class="code sev- "><tt><i>485</i>                 <span class="s1">&#39;occupancy&#39;</span><span class="p">:</span> <span class="n">occ</span><span class="p">,</span></tt>
            </div>
            <div id="l486"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>486</i>                 <span class="s1">&#39;beta&#39;</span><span class="p">:</span>      <span class="n">beta</span><span class="p">,</span></tt>
            </div>
            <div id="l487"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>487</i>                 <span class="s1">&#39;atomtype&#39;</span><span class="p">:</span>  <span class="n">element</span><span class="p">,</span></tt>
            </div>
            <div id="l488"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>488</i>                 <span class="s1">&#39;radius&#39;</span><span class="p">:</span>    <span class="n">radius</span><span class="p">,</span></tt>
            </div>
            <div id="l489"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>489</i>                 <span class="s1">&#39;charge&#39;</span><span class="p">:</span>    <span class="n">charge</span><span class="p">,</span></tt>
            </div>
            <div id="l490"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>490</i>                 <span class="s1">&#39;x&#39;</span><span class="p">:</span>         <span class="n">x</span><span class="p">,</span></tt>
            </div>
            <div id="l491"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>491</i>                 <span class="s1">&#39;y&#39;</span><span class="p">:</span>         <span class="n">y</span><span class="p">,</span></tt>
            </div>
            <div id="l492"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E241
                     </span>
                     Multiple spaces after ':'</li>
               
               </ul><tt><i>492</i>                 <span class="s1">&#39;z&#39;</span><span class="p">:</span>         <span class="n">z</span><span class="p">,</span></tt>
            </div>
            <div id="l493"
               class="code sev- "><tt><i>493</i>             <span class="p">})</span></tt>
            </div>
            <div id="l494"
               class="code sev- "><tt><i>494</i> &nbsp;</tt>
            </div>
            <div id="l495"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 5 places)</li>
               
               </ul><tt><i>495</i>         <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;atom&#39;</span><span class="p">,</span><span class="s1">&#39;index&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;resname&#39;</span><span class="p">,</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span><span class="s1">&#39;resid&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l496"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 4 places)</li>
               
               </ul><tt><i>496</i>                 <span class="s1">&#39;occupancy&#39;</span><span class="p">,</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span><span class="s1">&#39;atomtype&#39;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span><span class="s1">&#39;charge&#39;</span><span class="p">,</span></tt>
            </div>
            <div id="l497"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        E231
                     </span>
                     Missing whitespace after ',' (in 2 places)</li>
               
               </ul><tt><i>497</i>                 <span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">]</span></tt>
            </div>
            <div id="l498"
               class="code sev- "><tt><i>498</i>         <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span></tt>
            </div>
            <div id="l499"
               class="code sev- "><tt><i>499</i> &nbsp;</tt>
            </div>
            <div id="l500"
               class="code sev- "><tt><i>500</i>     <span class="k">def</span><span class="w"> </span><span class="nf">write_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span></tt>
            </div>
            <div id="l501"
               class="code sev- "><tt><i>501</i> <span class="w">        </span><span class="sd">&quot;&quot;&quot;</span></tt>
            </div>
            <div id="l502"
               class="code sev- "><tt><i>502</i> <span class="sd">        Write this MolDataFrame (with x,y,z) to a PDB file.</span></tt>
            </div>
            <div id="l503"
               class="code sev- "><tt><i>503</i> <span class="sd">        &quot;&quot;&quot;</span></tt>
            </div>
            <div id="l504"
               class="code sev- "><tt><i>504</i>         <span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span></tt>
            </div>
            <div id="l505"
               class="code sev- "><tt><i>505</i>             <span class="s2">&quot;ATOM  </span><span class="si">{index:5d}</span><span class="s2"> </span><span class="si">{name:^4s}{resname:&gt;3s}</span><span class="s2"> </span><span class="si">{chain:1s}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l506"
               class="code sev- "><tt><i>506</i>             <span class="s2">&quot;</span><span class="si">{resid:4d}</span><span class="s2">    </span><span class="si">{x:8.3f}{y:8.3f}{z:8.3f}</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l507"
               class="code sev- "><tt><i>507</i>             <span class="s2">&quot;</span><span class="si">{occupancy:6.2f}{beta:6.2f}</span><span class="s2">           </span><span class="si">{atomtype:&gt;2s}</span><span class="se">\n</span><span class="s2">&quot;</span></tt>
            </div>
            <div id="l508"
               class="code sev- "><tt><i>508</i>         <span class="p">)</span></tt>
            </div>
            <div id="l509"
               class="code sev- "><tt><i>509</i>         <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span></tt>
            </div>
            <div id="l510"
               class="code sev- "><tt><i>510</i>             <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">):</span></tt>
            </div>
            <div id="l511"
               class="code sev- "><tt><i>511</i>                 <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">row</span><span class="p">))</span></tt>
            </div>
            <div id="l512"
               class="code sev-2  le">
               <ul class="violations">
               
                  <li>
                     <span class="count sev-2">
                        W292
                     </span>
                     No newline at end of file</li>
               
               </ul><tt><i>512</i>             <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;TER</span><span class="se">\n</span><span class="s2">END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></tt>
            </div>
            
         </div>
      </div>
   </body>
</html>